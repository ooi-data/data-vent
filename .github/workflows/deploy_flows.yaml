name: Deploy Flows

on:
#   push:
#     branches:
#       - "main"
  workflow_dispatch:

env:
    ENV_FILE: .ci/data-vent.yml
    CONDA_ENV: data-vent
    CACHE_NUMBER: 0

jobs:
  register:
    name: Deploy Prefect Flow
    runs-on: ubuntu-20.04
    env:
     OOI_USERNAME: ${{ secrets.OOI_USERNAME }}
     OOI_TOKEN: ${{ secrets.OOI_TOKEN }}
     AWS_KEY: ${{ secrets.AWS_KEY }}
     AWS_SECRET: ${{ secrets.AWS_SECRET }}
     PREFECT_KEY: ${{ secrets.PREFECT_KEY }}
     #GOOGLE_SERVICE_JSON: ${{ secrets.GOOGLE_SERVICE_JSON }}
     #GH_PAT: ${{ secrets.GH_PAT }}
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_PAT }}
      - name: Setup micromamba
        uses: mamba-org/provision-with-micromamba@v14
        with:
          environment-file: ${{ env.ENV_FILE }}
          environment-name: ${{ env.CONDA_ENV }}
          cache-env: false
      - name: Print conda env
        run: |
          conda info
          conda list
      - name: Install package
        run: |
          pip install .
      - name: Authenticate Prefect Cloud
        run: |
          prefect cloud login -k ${{ env.PREFECT_KEY }} 
      - name: Deploy Prefect Flows
        run: |
          pwd
          python ./deploy.py
   
      